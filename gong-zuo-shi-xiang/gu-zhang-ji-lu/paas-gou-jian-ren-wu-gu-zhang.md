---
description: 23/4/20 线上环境出现构建任务故障 -- 待研究
---

# PaaS 构建任务故障

## 故障背景

9点上班时，应用反馈说构建任务一直处于运行中，无法正常结束

## 故障现象

早上7点40分到9点40分出现构建任务一直处于运行中直至持续集成超过30分钟后中断

10点20到12点期间有小部分任务出现故障

12点到12点40分、13点55到14点13分、 15点30到16点期间任务都无法正常运行

故障期间，cicd 服务的日志显示未执行任务队列入队，同时整个过程未出现错误提示。

日志记录显示，cicd 服务节点1断断续续执行了入队动作

### 故障排查

根据日志记录定位，任务状态修改后、任务队列入队前，cicd正在执行 tar / zip 包动作，且该动作如果出现异常，会进行异常日志输出。但按照日志记录内容，并未出现异常日志，初步怀疑是 tar / zip 包动作堵塞。

通过 pprof 导出 goroutine 内容，发现大约有20个goroutine正在执行在入队前的 mkdir , chmod , untar , unzip 动作，且堵塞着。

因此推测可能是 执行 mkdir/untar 所在的NAS出现故障。通过iostat / iotop 工具检查磁盘io情况，发现由cicd 容器服务产生的磁盘io 达到了99.9%。通过umount / mount 等命令对NAS盘进行卸载、重挂载等动作都无法恢复正常使用，且挂载过程非常缓慢。

但此时通过其他宿主机挂载相同的NAS盘并未发现该问题，挂载及访问速度正常 time ls 命令故障宿主机需要超过1分钟返回，其他宿主机均在10ms内返回。

结合 iostat 情况，推测与宿主机上面 cicd 容器磁盘占用相关，因此对故障宿主机的cicd容器在docker 服务上强制删除，并删除后该宿主机恢复的NAS连接恢复正常。

根据profile 记录，goroutine最后堵塞在 sysCall.SysCall6() / sysCall.SysCall() 两个函数中，需要对这两个函数进行进一步的了解才能知道故障原因。
